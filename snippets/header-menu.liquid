<nav class="{{ _class }}" role="navigation">

  <ap-navigationofdesktop>
    <ul class="header__linklist list--unstyled hd-pocket hd-lap" role="list">
      
      {%- for link in section.settings.menu.links -%}
        
        {%- assign hasMega = false -%} 
        {%- assign titleCheckMega = link.title | escape | split: '[' | first | split: '}' | last | downcase -%}

        {%- for block in section.blocks -%} 
          {%- assign megamenu_title = block.settings.parent_menu | escape | strip | downcase -%} 
          {%- if titleCheckMega == megamenu_title -%} 
                {%- assign hasMega = true -%} 
                {%- break -%} 
          {%- endif -%} 
        {%- endfor -%} 

        {%- for i in (1..4) -%} 
          {%- capture apmegamenu_title -%}apmenuitem_title_{{ i }}{%- endcapture-%} 
          {%- assign megamenu_title = section.settings[ apmegamenu_title ] | escape | strip | downcase -%} 
          {%- if titleCheckMega == megamenu_title -%} 
                {%- assign intMega = i -%} 
                {%- break -%} 
          {%- endif -%} 
        {%- endfor -%}

        {%- if hasMega -%} 

          {%- assign isFullwidth = true -%} 
          {%- assign settingWidth = 'apmenuitem_width_' | append: intMega -%} 
          {%- assign widthMega = section.settings[ settingWidth ] -%} 
          {%- if widthMega != 0 -%} 
            {%- assign isFullwidth = false -%}
          {%- endif -%} 

          {% liquid
            assign menu_index = forloop.index
            assign is_megamenu = false
            assign aria_controls = ''
            assign is_child_menu = ''
            assign is_child_image = ''
    
            for block in section.blocks
    
              assign aria_controls = 'desktop-menu-' | append: menu_index
    
              if block.settings.parent_megamenu == section.settings.menu and block.settings.parent_menu == link.title
    
              if block.type == 'image_block'
    
                assign is_megamenu = true
                assign is_child_image = true
                endif
    
              if block.type == 'child_menu'
              
                assign is_megamenu = true
                assign is_child_menu = true
                endif
    
              endif
    
            endfor
          %}
          <li class="header__linklist-item {% if is_megamenu == true %}has-dropdown{% endif %} {% unless isFullwidth %}mega-custom{% endunless %}"
            data-item-title="{{ link.title | escape }}">
            {% if is_megamenu == true %}
            <a class="header__linklist-link link--animated {% if link.current %}menu-item--active{% endif %}"
              href="{{ link.url }}" {% if aria_controls != '' %}ap-controlsaria="{{ aria_controls }}" {%
              endif %} ap-expanded-aria="false">
              <span>                 
                {{ link.title | escape }}
                {% render 'icon-dropdown' %}    
              </span>
 
              </a>
            {% if aria_controls != '' %}
            <div id="{{ aria_controls }}" class="mega-menu" hidden="" {% if isFullwidth %}style="width: 100%"{% endif %} {%- if widthMega != "0" -%}style="width: {{ widthMega }}px;"{%- endif -%} >
              <div class="container">
                <div class="mega-menu__inner">    
                  {% if is_child_menu == true %}
    
                  <div class="mega-menu__columns-wrapper">
                    {% for block in section.blocks %}
                    {% if block.type == 'child_menu' %}
                    {%- if block.settings.parent_megamenu == section.settings.menu and block.settings.parent_menu == link.title -%}
    
                    <div class="mega-menu__column">
                      {% if block.settings.heading != blank %}
                      <span class="mega-menu__title heading {{ block.settings.heading_size }}">{{
                        block.settings.heading }}</span>
                      {% endif %}
                      <ul class="linklist list--unstyled" role="list">
                        {%- for child_link in block.settings.menu.links -%}
                        <li class="linklist__item">
                          <a href="{{ child_link.url }}" class="link-menu">{{ child_link.title |
                            escape }}</a>
                        </li>
                        {% endfor %}
                      </ul>
                    </div>
    
                    {%- endif -%}
                    {% endif %}
                    {% endfor %}
                  </div>
                  {% endif %}
                  {% if is_child_image == true %}
    
                  <div class="mega-menu__images-wrapper">
                    {% for block in section.blocks %}
                    {% if block.type == 'image_block' %}
                    {%- if block.settings.parent_megamenu == section.settings.menu and
                    block.settings.parent_menu == link.title -%}
    
                    <a href="{{ block.settings.link }}" class="mega-menu__image-push image-zoom">
                    <p class="mega-menu__heading heading {{ block.settings.heading_size }}">{{
                        block.settings.heading }}</p>
                      <div class="mega-menu__image-wrapper">
                        <img class="mega-menu__image" loading="lazy" sizes="120px" alt=""
                          src="{{ block.settings.image | image_url : width: 560 }}"
                          srcset="{{ block.settings.image | image_url : width: 240 }} 240w, {{ block.settings.image | image_url : width: 480 }} 480w, {{ block.settings.image | image_url : width: 560 }} 560w"
                          width="100" height="100">
                      </div>
                      <span class="mega-menu__text">{{ block.settings.description }}</span>
                    </a>
    
                    {%- endif -%}
                    {% endif %}
                    {% endfor %}
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
            {% endif %}
            {% else %}
            <a class="header__linklist-link link--animated {% if link.current %}menu-item--active{% endif %}"
              href="{{ link.url }}">              
              <span>                 
                {{ link.title | escape }}  
              </span></a>
            {% endif %}
          </li>
          
        {%- elsif link.links != blank -%}

            <li class="header__linklist-item site-nav__item site-nav__item-normal {% if link.active %} site-nav--active{% endif %} site-nav__item-1">
              <a href="{{ link.url }}" class="header__linklist-link link--animated {% if link.current %}menu-item--active{% endif %} site-nav__link" {% if link.active %} aria-current="page"{% endif %}>
                <span class="site-nav__title">{%- render 'processMenuTitle' , itemName: link.title -%}</span>
                {% render 'icon-dropdown' %}
                {%- render 'processMenuLabel' , itemName: link.title -%}
              </a>
              <div class="site-nav__dropdown site-nav__dropdown-1 meganav">
                <ul class="meganav__nav">
                  {%- render 'site-nav', link: link -%}
                </ul>
              </div>
            </li>

        {%- else -%}

            <li class="header__linklist-item site-nav__item{% if link.active %} site-nav--active{% endif %} site-nav__item-1">
              <a href="{{ link.url }}" class="header__linklist-link link--animated site-nav__link"{% if link.active %} aria-current="page"{% endif %}>
                <span class="site-nav__title">{%- render 'processMenuTitle' , itemName: link.title -%}</span>
                {%- render 'processMenuLabel' , itemName: link.title -%}
              </a>
            </li>

        {%- endif -%} 


      {%- endfor -%}
    </ul>
  </ap-navigationofdesktop>

  <div class="header__icon-list ">
    <button is="toggle-button" class="header__icon-wrapper tap-area hd-desk icon-hamburger"
      ap-controlsaria="mobile-menu-drawer" ap-expanded-aria="false">
      <span class="visually-hidden">Navigation</span>
      <div class="icon-header">
        <svg focusable="false" width="18" height="14" class="icon icon--header-hamburger   "
          viewBox="0 0 18 14">
          <path d="M0 1h18M0 13h18H0zm0-6h18H0z" fill="none" stroke="currentColor" stroke-width="2">
          </path>
        </svg>    
      </div>
    </button>
    <a href="/search" is="ap-togglelink" class="header__icon-wrapper tap-area hd-desk icon-search icon-search-mobi"
      ap-controlsaria="search-drawer" ap-expanded-aria="false" aria-label="Search">     
      {% render "icon-search-header" %}
    </a>
  </div>

</nav>